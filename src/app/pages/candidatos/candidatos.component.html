<div class="usuario-container" [@pageAnimation]>

  <p-card>
    <ng-template pTemplate="header">
      <div class="card-header">
        <h2>{{ 'usuario.title' | translate }}</h2>
        <p class="card-subtitle">{{ 'usuario.subtitle' | translate }}</p>
      </div>
    </ng-template>
    <p-toolbar styleClass="mb-4">
      <p-button 
        severity="success" 
        [label]="'usuario.new' | translate"
        icon="pi pi-plus" 
        (onClick)="novoCandidato()">
      </p-button>
    </p-toolbar>
  <p-table [value]="filteredCandidatos" [loading]="loading">
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="nome">
            Nome
            <p-sortIcon field="nome"></p-sortIcon>
          </th>
          <th pSortableColumn="email">
            Email
            <p-sortIcon field="email"></p-sortIcon>
          </th>
          <th pSortableColumn="estado">
            Estado
            <p-sortIcon field="estado"></p-sortIcon>
          </th>
          <th pSortableColumn="vaga">
            Vaga
            <p-sortIcon field="vaga"></p-sortIcon>
          </th>
          <th pSortableColumn="situacao">
            Situação
            <p-sortIcon field="situacao"></p-sortIcon>
          </th>
          <th style="width: 200px">Ações</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-candidato>
        <tr>
          <td>
            <div class="user-info">
              <i class="pi pi-user user-icon"></i>
              <span class="user-name">{{ candidato.nome }}</span>
            </div>
          </td>
          <td>{{ candidato.email }}</td>
          <td>{{ candidato.estado }}</td>
          <td>{{ candidato.vaga }}</td>
          <td>
            <p-tag 
              [value]="candidato.situacao || 'Pendente'"
              [severity]="candidato.situacao === 'Processo Finalizado' ? 'success' : (candidato.situacao === 'Pendente' || !candidato.situacao ? 'warning' : 'info')"
              [style]="candidato.situacao === 'Processo Finalizado' ? {'background':'#43a047','color':'#fff'} : ((candidato.situacao === 'Pendente' || !candidato.situacao) ? {'background':'#fff9c4','color':'#a67c00'} : {})">
            </p-tag>
          </td>
          <td>
            <div class="action-buttons">
              <p-button 
                icon="pi pi-pencil" 
                severity="help" 
                size="small"
                title="Editar"
                (onClick)="editarCandidato(candidato)">
              </p-button>
              <p-button 
                icon="pi pi-trash" 
                severity="danger" 
                size="small"
                title="Excluir"
                (onClick)="confirmarExclusao(candidato)">
              </p-button>
              <p-button 
                *ngIf="isCurrentUserHR"
                icon="pi pi-file"
                severity="info"
                size="small"
                title="Acompanhar Documentos"
                (onClick)="abrirDocumentosDialog(candidato)">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="loadingbody">
        <tr *ngFor="let item of [1,2,3,4,5]">
          <td>
            <div class="user-info">
              <p-skeleton width="1.2rem" height="1.2rem" borderRadius="50%" class="skeleton-user-icon"></p-skeleton>
              <p-skeleton width="8rem" height="1rem" class="skeleton-user-name"></p-skeleton>
            </div>
          </td>
          <td>
            <p-skeleton width="12rem" height="1rem" class="skeleton-email"></p-skeleton>
          </td>
          <td>
            <p-skeleton width="3rem" height="1rem" class="skeleton-estado"></p-skeleton>
          </td>
          <td>
            <p-skeleton width="10rem" height="1rem" class="skeleton-vaga"></p-skeleton>
          </td>
          <td>
            <p-skeleton width="6rem" height="1.5rem" borderRadius="12px" class="skeleton-tag"></p-skeleton>
          </td>
          <td>
            <div class="action-buttons">
              <p-skeleton width="2rem" height="2rem" borderRadius="6px" class="skeleton-button"></p-skeleton>
              <p-skeleton width="2rem" height="2rem" borderRadius="6px" class="skeleton-button"></p-skeleton>
              <p-skeleton width="2rem" height="2rem" borderRadius="6px" class="skeleton-button"></p-skeleton>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center">
            <div class="empty-state">
              <i class="pi pi-users empty-icon"></i>
              <p>{{ 'usuario.empty' | translate }}</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Dialog para criar/editar candidato -->
  <p-dialog 
    [header]="isEditing ? 'Editar Candidato' : 'Novo Candidato'"
    [(visible)]="displayDialog" 
    [modal]="true" 
    [style]="{width: '450px', minHeight: '520px'}"
    [draggable]="false"
    [resizable]="false">
    <div class="dialog-content">
      <div style="display: flex; gap: 1rem;">
        <div class="field" style="flex:1;">
          <label for="nome">Nome *</label>
          <input 
            id="nome"
            type="text" 
            pInputText 
            [(ngModel)]="candidatoForm.nome"
            class="w-full"
            placeholder="Nome" />
        </div>
        <div *ngIf="!isEditing" class="field" style="flex:1;">
          <label for="cpf">CPF *</label>
          <input 
            id="cpf"
            type="text" 
            pInputText 
            [(ngModel)]="candidatoForm.cpf"
            class="w-full"
            placeholder="Somente números" />
        </div>
      </div>
        <div *ngIf="isEditing" class="field">
          <label for="situacao">Situação</label>
          <p-dropdown 
            id="situacao"
            [options]="[
              {label: 'Pendente', value: 'Pendente'},
              {label: 'Processo Finalizado', value: 'Processo Finalizado'}
            ]"
            appendTo="body"
            [(ngModel)]="candidatoForm.situacao"
            placeholder="Selecione a situação"
            class="w-full">
          </p-dropdown>
        </div>
      <div class="field" >
        <label for="vaga">Vaga</label>
        <input 
          id="vaga"
          type="text" 
          pInputText 
          [(ngModel)]="candidatoForm.vaga"
          class="w-full"
          placeholder="Vaga" />
      </div>
      <div style="display: flex; gap: 1rem; margin-top: 1rem;">
        <div class="field" style="flex:1;">
          <label for="email">Email *</label>
          <input 
            id="email"
            type="email" 
            pInputText 
            [(ngModel)]="candidatoForm.email"
            class="w-full"
            placeholder="Email" />
        </div>
        <div class="field" style="flex:1;">
          <label for="telefone">Telefone</label>
          <input 
            id="telefone"
            type="text" 
            pInputText 
            [(ngModel)]="candidatoForm.telefone"
            class="w-full"
            placeholder="Somente números" />
        </div>
      </div>
      <div style="display: flex; gap: 1rem;">
        <div class="field" style="flex:1;">
          <label for="sexo">Sexo</label>
          <p-dropdown 
            id="sexo"
            [options]="[
              {label: 'Masculino', value: 'Masculino'},
              {label: 'Feminino', value: 'Feminino'},
              {label: 'Outro', value: 'Outro'}
            ]"
            appendTo="body"
            [(ngModel)]="candidatoForm.sexo"
            placeholder="Selecione o sexo"
            class="w-full">
          </p-dropdown>
        </div>
        <div class="field" style="flex:1;">
          <label for="estado">Estado</label>
          <p-dropdown 
            id="estado"
            appendTo="body"
            [options]="[
              {label: 'AC', value: 'AC'}, {label: 'AL', value: 'AL'}, {label: 'AP', value: 'AP'}, {label: 'AM', value: 'AM'},
              {label: 'BA', value: 'BA'}, {label: 'CE', value: 'CE'}, {label: 'DF', value: 'DF'}, {label: 'ES', value: 'ES'},
              {label: 'GO', value: 'GO'}, {label: 'MA', value: 'MA'}, {label: 'MT', value: 'MT'}, {label: 'MS', value: 'MS'},
              {label: 'MG', value: 'MG'}, {label: 'PA', value: 'PA'}, {label: 'PB', value: 'PB'}, {label: 'PR', value: 'PR'},
              {label: 'PE', value: 'PE'}, {label: 'PI', value: 'PI'}, {label: 'RJ', value: 'RJ'}, {label: 'RN', value: 'RN'},
              {label: 'RS', value: 'RS'}, {label: 'RO', value: 'RO'}, {label: 'RR', value: 'RR'}, {label: 'SC', value: 'SC'},
              {label: 'SP', value: 'SP'}, {label: 'SE', value: 'SE'}, {label: 'TO', value: 'TO'}
            ]"
            [(ngModel)]="candidatoForm.estado"
            placeholder="Selecione o estado"
            class="w-full"
            filter="true">
          </p-dropdown>
        </div>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <p-button 
          label="Cancelar"
          icon="pi pi-times" 
          variant="outlined"
          severity="secondary"
          (onClick)="fecharDialog()">
        </p-button>
        <p-button 
          label="Salvar"
          icon="pi pi-check" 
          (onClick)="salvarCandidato()"
          [loading]="loading">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Dialog de Documentos do Candidato -->
  <p-dialog 

      header=""
      [(visible)]="showDocumentosDialog"
      [modal]="true"
      [style]="{width: '650px', maxWidth: '98vw'}"
      [draggable]="false" [resizable]="false"
      contentStyle="padding:0;">
      <div *ngIf="candidatoSelecionado" class="doc-modal-content">
        <div class="doc-modal-header">
          <i class="pi pi-user"></i>
          <span>Documentos enviados de <b>{{ candidatoSelecionado.nome }}</b></span>
        </div>
        <div class="doc-list-section">
          <ul class="doc-list">
            <li *ngFor="let doc of documentosSelecionados" class="doc-card">
              <div class="doc-card-content">
                <div class="doc-card-left">
                  <i class="pi pi-file"></i>
                  <div>
                    <div class="doc-type"><strong>Tipo:</strong> {{ doc.tipo_documento }}</div>
                    <div class="doc-name"><strong>Documento:</strong> {{ doc.nome_documento }}</div>
                  </div>
                </div>
                <div class="doc-card-right">
                  <span class="doc-status-label" style="font-weight: 500; margin-right: 0.5rem;">Status:</span>
                  <p-tag
                    [value]="doc.status === 'APROVADO' ? 'Aprovado' : (doc.status === 'REPROVADO' ? 'Reprovado' : (doc.status === 'analisando' ? 'Analisando' : doc.status))"
                    [severity]="doc.status === 'APROVADO' ? 'success' : (doc.status === 'REPROVADO' ? 'danger' : (doc.status === 'analisando' ? 'info' : 'warning'))"
                    class="doc-status-tag">
                  </p-tag>
                  <div class="doc-actions" style="display: flex; gap: 0.5rem; margin-left: 0.5rem;">
                    <p-button
                      *ngIf="isCurrentUserHR"
                      icon="pi pi-download"
                      title="Baixar Documento"
                      severity="info"
                      size="small"
                      (onClick)="downloadDocumento(doc)"
                      [loading]="doc.downloading"
                      class="doc-download-btn">
                    </p-button>
                    <p-button
                      *ngIf="isCurrentUserHR && doc.status !== 'APROVADO'"
                      icon="pi pi-check"
                      label="Aprovar"
                      severity="success"
                      size="small"
                      (onClick)="aprovarDocumento(candidatoSelecionado, doc)"
                      class="doc-approve-btn">
                    </p-button>
                  </div>
                </div>
              </div>
            </li>
            <li *ngIf="documentosSelecionados.length === 0" class="doc-empty-state">
              <i class="pi pi-folder-open"></i>
              <div>Nenhum documento enviado.</div>
            </li>
          </ul>
        </div>
      </div>
    </p-dialog>

  <p-dialog 
    [header]="('usuario.info' | translate)"
    [(visible)]="displayDialogInfo" 
    [modal]="true" 
    [style]="{width: '450px'}"
    [draggable]="false"
    [resizable]="false">

    <div class="dialog-content">
      <div class="field">
        <p-tag severity="secondary"
          [value]="'Ao adicionar o candidato no sistema, automaticamente será enviado o login para o mesmo com o acesso a está plataforma para ser enviado os documentos.'">
        </p-tag>
      </div>
    </div>
  </p-dialog>

  <!-- Toast para mensagens -->
  <p-toast></p-toast>
  
  <!-- Confirmation Dialog -->
  <p-confirmDialog></p-confirmDialog>
</div>
