<div class="usuario-container" [@pageAnimation]>

  <p-card>
    <ng-template pTemplate="header">
      <div class="card-header">
        <h2>{{ 'usuario.title' | translate }}</h2>
        <p class="card-subtitle">{{ 'usuario.subtitle' | translate }}</p>
      </div>
    </ng-template>
    <p-toolbar styleClass="mb-4">
      <p-button 
        severity="success" 
        [label]="'usuario.new' | translate"
        icon="pi pi-plus" 
        (onClick)="novoCandidato()">
      </p-button>
    </p-toolbar>
  <p-table [value]="filteredCandidatos">
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="nome">
            Nome
            <p-sortIcon field="nome"></p-sortIcon>
          </th>
          <th pSortableColumn="email">
            Email
            <p-sortIcon field="email"></p-sortIcon>
          </th>
          <th pSortableColumn="estado">
            Estado
            <p-sortIcon field="estado"></p-sortIcon>
          </th>
          <th pSortableColumn="vaga">
            Vaga
            <p-sortIcon field="vaga"></p-sortIcon>
          </th>
          <th pSortableColumn="situacao">
            Situação
            <p-sortIcon field="situacao"></p-sortIcon>
          </th>
          <th style="width: 200px">Ações</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-candidato>
        <tr>
          <td>
            <div class="user-info">
              <i class="pi pi-user user-icon"></i>
              <span class="user-name">{{ candidato.nome }}</span>
            </div>
          </td>
          <td>{{ candidato.email }}</td>
          <td>{{ candidato.estado }}</td>
          <td>{{ candidato.vaga }}</td>
          <td>
            <p-tag 
              [value]="candidato.situacao || 'Pendente'"
              severity="{{ (candidato.situacao === 'Pendente' || !candidato.situacao) ? 'warning' : (candidato.situacao === 'Processo Finalizado' ? 'success' : 'info') }}">
            </p-tag>
          </td>
          <td>
            <div class="action-buttons">
              <p-button 
                icon="pi pi-pencil" 
                severity="help" 
                size="small"
                title="Editar"
                (onClick)="editarCandidato(candidato)">
              </p-button>
              <p-button 
                icon="pi pi-trash" 
                severity="danger" 
                size="small"
                title="Excluir"
                (onClick)="confirmarExclusao(candidato)">
              </p-button>
              <p-button 
                *ngIf="isCurrentUserHR"
                icon="pi pi-file"
                severity="info"
                size="small"
                title="Acompanhar Documentos"
                (onClick)="abrirDocumentosDialog(candidato)">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="loadingbody">
        <tr>
          <td><p-skeleton height="2rem"></p-skeleton></td>
          <td><p-skeleton height="2rem"></p-skeleton></td>
          <td><p-skeleton height="2rem"></p-skeleton></td>
          <td><p-skeleton height="2rem"></p-skeleton></td>
          <td><p-skeleton height="2rem"></p-skeleton></td>
          <td>
            <div class="action-buttons">
              <p-skeleton width="2rem" height="2rem" borderRadius="4px"></p-skeleton>
              <p-skeleton width="2rem" height="2rem" borderRadius="4px"></p-skeleton>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="loadingbody">
        <tr *ngFor="let item of [1,2,3,4,5]">
          <td>
            <div class="user-info">
              <div class="skeleton-icon"></div>
              <div class="skeleton-text skeleton-name"></div>
            </div>
          </td>
          <td>
            <div class="skeleton-text skeleton-email"></div>
          </td>
          <td>
            <div class="skeleton-tag"></div>
          </td>
          <td>
            <div class="skeleton-tag"></div>
          </td>
          <td>
            <div class="skeleton-tag skeleton-small"></div>
          </td>
          <td>
            <div class="action-buttons">
              <div class="skeleton-button"></div>
              <div class="skeleton-button"></div>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center">
            <div class="empty-state">
              <i class="pi pi-users empty-icon"></i>
              <p>{{ 'usuario.empty' | translate }}</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Dialog para criar/editar candidato -->
  <p-dialog 
    [header]="isEditing ? 'Editar Candidato' : 'Novo Candidato'"
    [(visible)]="displayDialog" 
    [modal]="true" 
    [style]="{width: '450px', minHeight: '520px'}"
    [draggable]="false"
    [resizable]="false">
    <div class="dialog-content">
      <div style="display: flex; gap: 1rem;">
        <div class="field" style="flex:1;">
          <label for="nome">Nome *</label>
          <input 
            id="nome"
            type="text" 
            pInputText 
            [(ngModel)]="candidatoForm.nome"
            class="w-full"
            placeholder="Nome" />
        </div>
        <div *ngIf="!isEditing" class="field" style="flex:1;">
          <label for="cpf">CPF *</label>
          <input 
            id="cpf"
            type="text" 
            pInputText 
            [(ngModel)]="candidatoForm.cpf"
            class="w-full"
            placeholder="Somente números" />
        </div>
      </div>
        <div *ngIf="isEditing" class="field">
          <label for="situacao">Situação</label>
          <p-dropdown 
            id="situacao"
            [options]="[
              {label: 'Pendente', value: 'Pendente'},
              {label: 'Processo Finalizado', value: 'Processo Finalizado'}
            ]"
            appendTo="body"
            [(ngModel)]="candidatoForm.situacao"
            placeholder="Selecione a situação"
            class="w-full">
          </p-dropdown>
        </div>
      <div class="field" >
        <label for="vaga">Vaga</label>
        <input 
          id="vaga"
          type="text" 
          pInputText 
          [(ngModel)]="candidatoForm.vaga"
          class="w-full"
          placeholder="Vaga" />
      </div>
      <div style="display: flex; gap: 1rem; margin-top: 1rem;">
        <div class="field" style="flex:1;">
          <label for="email">Email *</label>
          <input 
            id="email"
            type="email" 
            pInputText 
            [(ngModel)]="candidatoForm.email"
            class="w-full"
            placeholder="Email" />
        </div>
        <div class="field" style="flex:1;">
          <label for="telefone">Telefone</label>
          <input 
            id="telefone"
            type="text" 
            pInputText 
            [(ngModel)]="candidatoForm.telefone"
            class="w-full"
            placeholder="Somente números" />
        </div>
      </div>
      <div style="display: flex; gap: 1rem;">
        <div class="field" style="flex:1;">
          <label for="sexo">Sexo</label>
          <p-dropdown 
            id="sexo"
            [options]="[
              {label: 'Masculino', value: 'Masculino'},
              {label: 'Feminino', value: 'Feminino'},
              {label: 'Outro', value: 'Outro'}
            ]"
            appendTo="body"
            [(ngModel)]="candidatoForm.sexo"
            placeholder="Selecione o sexo"
            class="w-full">
          </p-dropdown>
        </div>
        <div class="field" style="flex:1;">
          <label for="estado">Estado</label>
          <p-dropdown 
            id="estado"
            appendTo="body"
            [options]="[
              {label: 'AC', value: 'AC'}, {label: 'AL', value: 'AL'}, {label: 'AP', value: 'AP'}, {label: 'AM', value: 'AM'},
              {label: 'BA', value: 'BA'}, {label: 'CE', value: 'CE'}, {label: 'DF', value: 'DF'}, {label: 'ES', value: 'ES'},
              {label: 'GO', value: 'GO'}, {label: 'MA', value: 'MA'}, {label: 'MT', value: 'MT'}, {label: 'MS', value: 'MS'},
              {label: 'MG', value: 'MG'}, {label: 'PA', value: 'PA'}, {label: 'PB', value: 'PB'}, {label: 'PR', value: 'PR'},
              {label: 'PE', value: 'PE'}, {label: 'PI', value: 'PI'}, {label: 'RJ', value: 'RJ'}, {label: 'RN', value: 'RN'},
              {label: 'RS', value: 'RS'}, {label: 'RO', value: 'RO'}, {label: 'RR', value: 'RR'}, {label: 'SC', value: 'SC'},
              {label: 'SP', value: 'SP'}, {label: 'SE', value: 'SE'}, {label: 'TO', value: 'TO'}
            ]"
            [(ngModel)]="candidatoForm.estado"
            placeholder="Selecione o estado"
            class="w-full"
            filter="true">
          </p-dropdown>
        </div>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <p-button 
          label="Cancelar"
          icon="pi pi-times" 
          variant="outlined"
          severity="secondary"
          (onClick)="fecharDialog()">
        </p-button>
        <p-button 
          label="Salvar"
          icon="pi pi-check" 
          (onClick)="salvarCandidato()"
          [loading]="loading">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Dialog de Documentos do Candidato -->
  <p-dialog 
    header="Acompanhamento de Documentos" 
    [(visible)]="showDocumentosDialog" 
    [modal]="true" 
    [style]="{width: '650px', maxWidth: '98vw'}"
    [draggable]="false" [resizable]="false">
    <div *ngIf="candidatoSelecionado">
      <div class="doc-list-section" style="padding: 1rem 0;">
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
          <i class="pi pi-user" style="font-size: 1.5rem; color: var(--primary-color);"></i>
          <span class="doc-list-title" style="font-size: 1.1rem; font-weight: 500;">Documentos enviados de <b>{{ candidatoSelecionado.nome }}</b>:</span>
        </div>
        <ul class="doc-list" style="list-style: none; padding: 0; margin: 0;">
          <li *ngFor="let doc of documentosSelecionados" style="margin-bottom: 1rem;">
            <div class="doc-item-content" style="display: flex; align-items: center; gap: 1rem; background: var(--surface-b); border-radius: 8px; padding: 0.75rem 1rem; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
              <i class="pi pi-file" style="font-size: 1.2rem; color: var(--primary-color);"></i>
              <span class="doc-name" style="font-weight: 500; min-width: 50px;"><strong>Tipo: </strong>{{ doc.tipo_documento }}</span>
              <span class="doc-name" style="font-weight: 500; min-width: 50px;"><strong>Documento: </strong>{{ doc.nome_documento }}</span>
              <p-tag 
                [value]="
                  doc.status === 'valido' ? 'Válido' : 
                  (doc.status === 'invalido' ? 'Inválido' : 
                  (doc.status === 'analisando' ? 'Analisando' : 'Pendente'))
                " 
                [severity]="
                  doc.status === 'valido' ? 'success' : 
                  (doc.status === 'invalido' ? 'danger' : 
                  (doc.status === 'analisando' ? 'info' : 'warning'))
                "
                class="doc-status-tag"
                [ngStyle]="{ 'min-width': '90px', 'text-align': 'center' }">
              </p-tag>
              <p-button
                *ngIf="isCurrentUserHR && doc.status !== 'valido'"
                icon="pi pi-check"
                label="Aprovar"
                severity="success"
                size="small"
                (onClick)="aprovarDocumento(candidatoSelecionado, doc)"
                [ngStyle]="{ 'margin-left': 'auto' }"
                class="ml-2">
              </p-button>
            </div>
          </li>
          <li *ngIf="documentosSelecionados.length === 0" style="text-align: center; color: var(--text-color-secondary); padding: 2rem 0;">
            <i class="pi pi-folder-open" style="font-size: 2rem; color: var(--surface-d);"></i>
            <div>Nenhum documento enviado.</div>
          </li>
        </ul>
      </div>
    </div>
  </p-dialog>

  <p-dialog 
    [header]="('usuario.info' | translate)"
    [(visible)]="displayDialogInfo" 
    [modal]="true" 
    [style]="{width: '450px'}"
    [draggable]="false"
    [resizable]="false">

    <div class="dialog-content">
      <div class="field">
        <p-tag severity="secondary"
          [value]="'Ao adicionar o candidato no sistema, automaticamente será enviado o login para o mesmo com o acesso a está plataforma para ser enviado os documentos.'">
        </p-tag>
      </div>
    </div>
  </p-dialog>

  <!-- Toast para mensagens -->
  <p-toast></p-toast>
  
  <!-- Confirmation Dialog -->
  <p-confirmDialog></p-confirmDialog>
</div>
