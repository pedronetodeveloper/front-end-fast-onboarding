<div class="curso-container" [@pageAnimation]>
  <p-card>
    <ng-template pTemplate="header">
      <div class="card-header">
        <h2>{{ 'curso.title' | translate }}</h2>
        <p class="card-subtitle">{{ 'curso.subtitle' | translate }}</p>
      </div>
    </ng-template>

    <p-toolbar styleClass="mb-4">
      <ng-template pTemplate="left">
        <p-button 
          severity="success" 
          [label]="'curso.new' | translate"
          icon="pi pi-plus" 
          (onClick)="novoCurso()">
        </p-button>
      </ng-template>
      
      <ng-template pTemplate="center">
        <div class="search-container">
            <p-iconfield>
                <p-inputicon class="pi pi-search" />
                <input type="text" pInputText placeholder="Search" />
            </p-iconfield>
        </div>
      </ng-template>
    </p-toolbar>

    <p-table 
      [value]="filteredCursos" 
      [loading]="loading"
      [scrollable]="true"
      scrollHeight="400px"
      styleClass="p-datatable-striped"
      [sortField]="sortField"
      [sortOrder]="sortOrder"
      (onSort)="onSort($event)">
      
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="usuario.nome">
            {{ 'curso.student' | translate }}
            <p-sortIcon field="usuario.nome"></p-sortIcon>
          </th>
          <th pSortableColumn="iniciado">
            {{ 'curso.status' | translate }}
            <p-sortIcon field="iniciado"></p-sortIcon>
          </th>
          <th pSortableColumn="nivelInicial">
            {{ 'curso.initialLevel' | translate }}
            <p-sortIcon field="nivelInicial"></p-sortIcon>
          </th>
          <th pSortableColumn="nivelAtual">
            {{ 'curso.currentLevel' | translate }}
            <p-sortIcon field="nivelAtual"></p-sortIcon>
          </th>
          <th pSortableColumn="unidadeAtual">
            {{ 'curso.currentUnit' | translate }}
            <p-sortIcon field="unidadeAtual"></p-sortIcon>
          </th>
          <th>{{ 'curso.progress' | translate }}</th>
          <th style="width: 200px">{{ 'common.actions' | translate }}</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-curso>
        <tr>
          <td>
            <div class="student-info">
              <i class="pi pi-user student-icon"></i>
              <div class="student-details">
                <span class="student-name">{{ curso.usuario?.nome }}</span>
                <small class="student-email">{{ curso.usuario?.email }}</small>
              </div>
            </div>
          </td>
          <td>
            <p-tag 
              [value]="getStatusText(curso.iniciado || false)"
              [severity]="getStatusSeverity(curso.iniciado || false)">
            </p-tag>
          </td>
          <td>
            <p-tag 
              [value]="'Nível ' + (curso.nivelInicial || 1)"
              severity="info">
            </p-tag>
          </td>
          <td>
            <p-tag 
              [value]="'Nível ' + (curso.nivelAtual || 1)"
              severity="secondary">
            </p-tag>
          </td>
          <td>
            <div class="unit-info">
              <span class="unit-current">{{ curso.unidadeAtual || 1 }}</span>
              <small class="unit-completed">({{ curso.unidadesFeitas || 0 }} {{ 'curso.completed' | translate }})</small>
            </div>
          </td>
          <td>
            <div class="progress-info">
              <p-progressBar 
                [value]="calcularProgresso(curso)"
                [showValue]="false"
                styleClass="progress-bar">
              </p-progressBar>
              <small class="progress-text">{{ calcularProgresso(curso) }}%</small>
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <p-button 
                icon="pi pi-pencil" 
                severity="info" 
                size="small"
                [title]="'common.edit' | translate"
                (onClick)="editarCurso(curso)">
              </p-button>
              <p-button 
                icon="pi pi-trash" 
                severity="danger" 
                size="small"
                [title]="'common.delete' | translate"
                (onClick)="confirmarExclusao(curso)">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="loadingbody">
        <tr *ngFor="let item of [1,2,3,4,5]">
          <td>
            <div class="student-info">
              <div class="skeleton-icon"></div>
              <div class="student-details">
                <div class="skeleton-text skeleton-name"></div>
                <div class="skeleton-text skeleton-email"></div>
              </div>
            </div>
          </td>
          <td>
            <div class="skeleton-tag"></div>
          </td>
          <td>
            <div class="skeleton-tag skeleton-level"></div>
          </td>
          <td>
            <div class="skeleton-tag skeleton-level"></div>
          </td>
          <td>
            <div class="unit-info">
              <div class="skeleton-text skeleton-unit"></div>
              <div class="skeleton-text skeleton-unit-small"></div>
            </div>
          </td>
          <td>
            <div class="progress-info">
              <div class="skeleton-progress"></div>
              <div class="skeleton-text skeleton-percent"></div>
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <div class="skeleton-button"></div>
              <div class="skeleton-button"></div>
            </div>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center">
            <div class="empty-state">
              <i class="pi pi-book empty-icon"></i>
              <p>{{ 'curso.empty' | translate }}</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Dialog para criar/editar curso -->
  <p-dialog 
    [header]="isEditing ? ('curso.edit' | translate) : ('curso.new' | translate)"
    [(visible)]="displayDialog" 
    [modal]="true" 
    [style]="{width: '500px'}"
    [draggable]="false"
    [resizable]="false">
    
    <div class="dialog-content">
      <div class="field">
        <label for="usuario">{{ 'curso.student' | translate }} *</label>
        <p-dropdown 
          id="usuario"
          [(ngModel)]="cursoForm.usuarioId"
          [options]="usuarios"
          optionLabel="nome"
          optionValue="id"
          class="w-full"
          [placeholder]="'curso.selectStudent' | translate">
          <ng-template pTemplate="selectedItem" let-option>
            <div class="dropdown-item" *ngIf="option">
              <span class="item-name">{{ option.nome }}</span>
              <small class="item-email">{{ option.email }}</small>
            </div>
          </ng-template>
          <ng-template pTemplate="item" let-option>
            <div class="dropdown-item">
              <span class="item-name">{{ option.nome }}</span>
              <small class="item-email">{{ option.email }}</small>
            </div>
          </ng-template>
        </p-dropdown>
      </div>

      <div class="field-group">
        <div class="field">
          <label for="nivelInicial">{{ 'curso.initialLevel' | translate }}</label>
          <p-inputNumber 
            id="nivelInicial"
            [(ngModel)]="cursoForm.nivelInicial"
            [min]="1"
            [max]="50"
            class="w-full">
          </p-inputNumber>
        </div>

        <div class="field">
          <label for="nivelAtual">{{ 'curso.currentLevel' | translate }}</label>
          <p-inputNumber 
            id="nivelAtual"
            [(ngModel)]="cursoForm.nivelAtual"
            [min]="1"
            [max]="50"
            class="w-full">
          </p-inputNumber>
        </div>
      </div>

      <div class="field-group">
        <div class="field">
          <label for="unidadeAtual">{{ 'curso.currentUnit' | translate }}</label>
          <p-inputNumber 
            id="unidadeAtual"
            [(ngModel)]="cursoForm.unidadeAtual"
            [min]="1"
            [max]="100"
            class="w-full">
          </p-inputNumber>
        </div>

        <div class="field">
          <label for="unidadesFeitas">{{ 'curso.completedUnits' | translate }}</label>
          <p-inputNumber 
            id="unidadesFeitas"
            [(ngModel)]="cursoForm.unidadesFeitas"
            [min]="0"
            [max]="100"
            class="w-full">
          </p-inputNumber>
        </div>
      </div>

      <div class="field">
        <div class="checkbox-field">
          <p-checkbox 
            id="iniciado"
            [(ngModel)]="cursoForm.iniciado"
            [binary]="true">
          </p-checkbox>
          <label for="iniciado" class="checkbox-label">{{ 'curso.started' | translate }}</label>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <p-button 
          [label]="'common.cancel' | translate"
          icon="pi pi-times" 
          severity="secondary"
          (onClick)="fecharDialog()">
        </p-button>
        <p-button 
          [label]="'common.save' | translate"
          icon="pi pi-check" 
          (onClick)="salvarCurso()"
          [loading]="loading">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Toast para mensagens -->
  <p-toast></p-toast>
  
  <!-- Confirmation Dialog -->
  <p-confirmDialog></p-confirmDialog>
</div>
